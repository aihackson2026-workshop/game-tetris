# 难度递增系统说明

## 概述

游戏实现了基于分数的动态难度调整系统。随着玩家分数的增加，方块下落速度会逐渐加快，但不会超过人类反应极限。同时，服务端会实时验证方块下落时间，防止暂停或加速作弊。

## 核心特性

### 1. 动态难度调整
- ✅ 根据分数自动调整下落速度
- ✅ 12 个难度等级（新手 → 神级）
- ✅ 最快速度 200ms（人类极限）
- ✅ 平滑过渡，体验流畅

### 2. 速度作弊检测
- ✅ 服务端实时验证下落时间
- ✅ 检测暂停作弊
- ✅ 检测加速作弊
- ✅ 自动拦截并终止游戏

### 3. 容错机制
- ✅ 20% 速度容差
- ✅ 考虑网络延迟
- ✅ 连续违规才判定作弊
- ✅ 人性化处理边缘情况

## 难度等级表

| 等级 | 名称 | 所需分数 | 下落间隔 | 说明 |
|------|------|---------|---------|------|
| 1 | 新手 | 0 | 1000ms | 初始速度，适合新手 |
| 2 | 初级 | 500 | 900ms | 略微加速 |
| 3 | 中级 | 1000 | 800ms | 开始有挑战 |
| 4 | 高级 | 2000 | 700ms | 需要集中注意力 |
| 5 | 专家 | 3000 | 600ms | 考验反应速度 |
| 6 | 大师 | 4000 | 500ms | 高手才能达到 |
| 7 | 宗师 | 5000 | 450ms | 顶尖玩家 |
| 8 | 传奇 | 6000 | 400ms | 传说级别 |
| 9 | 神话 | 7000 | 350ms | 接近极限 |
| 10 | 至尊 | 8000 | 300ms | 大师级操作 |
| 11 | 超凡 | 10000 | 250ms | 超越常人 |
| 12 | 神级 | 15000 | 200ms | 人类极限 |

## 人类反应时间考虑

### 反应时间分析

**科学依据：**
- 简单反应时间：150-250ms
- 选择反应时间：250-350ms
- 复杂认知反应：300-500ms

**俄罗斯方块操作时间：**
1. 识别方块类型：50-100ms
2. 决策最佳位置：100-200ms
3. 手指移动操作：50-100ms
4. **总计：200-400ms**

**安全下限设定：**
- 理论最快：200ms（纯反应）
- 实际游戏：300-400ms（需要决策）
- **系统设定：200ms**（留有余地）

### 为什么 200ms 是极限？

**1. 生理限制**
- 神经传导速度：50-120 m/s
- 大脑处理时间：100-200ms
- 肌肉响应时间：30-50ms

**2. 游戏体验**
- 低于 200ms 会感到压力过大
- 容易导致挫败感
- 影响游戏乐趣

**3. 公平性**
- 大部分玩家无法低于 300ms
- 200ms 已经是顶级玩家水平
- 保证竞技公平性

## 速度验证机制

### 验证逻辑

**每次方块锁定时检测：**
```javascript
实际下落时间 = 当前时间 - 方块开始时间

期望范围 = {
  min: 理想时间 × (1 - 20%) // 最快
  max: 理想时间 × (1 + 20%) // 最慢
}

if (实际时间 < min) {
  // 太快 - 可能加速作弊
  违规计数++;
} else if (实际时间 > 5000ms) {
  // 超时 - 可能暂停作弊
  暂停计数++;
}
```

### 判定标准

**加速作弊：**
- 连续 3 次下落时间过快
- 判定：作弊，强制结束游戏

**暂停作弊：**
- 单次暂停 > 5 秒
- 累计暂停 > 2 次
- 判定：作弊，强制结束游戏

**正常游戏：**
- 在期望范围内
- 偶尔超出范围（容错）
- 判定：正常

### 容错机制

**20% 速度容差：**
```
等级 5 (专家): 600ms
允许范围: 480ms - 720ms (±20%)

太快: < 480ms (可能作弊)
正常: 480-720ms
较慢: 720-5000ms (可能网络延迟)
超时: > 5000ms (可能暂停)
```

**连续违规判定：**
- 单次违规：警告，计数 +1
- 正常一次：计数 -1（容错恢复）
- 连续 3 次：判定作弊

## 技术实现

### 服务端计时

**开始计时：**
```javascript
// 游戏开始时
player.currentPieceStartTime = Date.now();

// 每次获取新方块时
player.currentPieceStartTime = now;
```

**验证时间：**
```javascript
// 请求下一个方块时
const fallTime = now - player.currentPieceStartTime;
const validation = DifficultyConfig.validateFallTime(fallTime, score);

if (!validation.valid) {
  player.speedViolations++;
  if (player.speedViolations >= 3) {
    throw new Error('检测到速度作弊');
  }
}
```

### 客户端速度调整

**接收服务端配置：**
```javascript
// 游戏开始
dropInterval = data.dropInterval; // 1000ms

// 获取下一个方块
if (data.dropInterval) {
  dropInterval = data.dropInterval; // 动态更新
}
```

**应用到游戏循环：**
```javascript
function update(timestamp) {
  const currentTime = Date.now();
  
  // 根据服务端配置的间隔自动下落
  if (currentTime - lastDropTime > dropInterval) {
    moveDown();
    lastDropTime = currentTime;
  }
  
  // ...
}
```

## 难度提升体验

### 视觉提示

**难度等级提升时：**
1. 显示全屏通知
2. 显示新等级名称
3. 动画效果（放大缩小）
4. 2 秒后自动消失

**示例：**
```
┌────────────────────────┐
│  难度提升！             │
│  等级 5 - 专家          │
└────────────────────────┘
```

### 音效提示（可选）

建议添加：
- 难度提升音效
- 达到神级音效
- 速度警告音效

## 作弊检测示例

### 场景1：暂停游戏

**玩家操作：**
```
方块开始: 10:00:00.000
暂停游戏: 10:00:02.000
继续游戏: 10:00:10.000 (暂停8秒)
方块锁定: 10:00:11.000
```

**服务端检测：**
```
实际下落时间: 11000ms
期望最大时间: 720ms (等级5, +20%)
超时阈值: 5000ms

判定: 暂停超时，暂停计数 +1
```

### 场景2：加速作弊

**玩家操作：**
```
方块1: 200ms (正常)
方块2: 100ms (异常快)
方块3: 100ms (异常快)
方块4: 100ms (异常快)
```

**服务端检测：**
```
方块2: 100ms < 480ms (期望最小)
  违规计数: 1

方块3: 100ms < 480ms
  违规计数: 2

方块4: 100ms < 480ms
  违规计数: 3 → 作弊判定！
```

### 场景3：网络波动（正常）

**玩家操作：**
```
方块1: 600ms (正常)
方块2: 800ms (网络延迟)
方块3: 550ms (正常)
方块4: 900ms (网络延迟)
```

**服务端检测：**
```
方块2: 800ms > 720ms (略慢)
  判定: 可能网络延迟，允许

方块4: 900ms > 720ms (略慢)
  判定: 可能网络延迟，允许

未达到作弊阈值，继续游戏
```

## 配置调整

### 修改难度曲线

编辑 `difficultyConfig.js`:

```javascript
LEVELS: [
  { score: 0,    interval: 1000, level: 1, name: '新手' },
  { score: 500,  interval: 900,  level: 2, name: '初级' },
  // 添加新等级或修改现有等级
]
```

### 修改容错率

```javascript
SPEED_VALIDATION: {
  TOLERANCE_RATIO: 0.2,      // 调整容错率 (0.2 = 20%)
  SUSPICIOUS_COUNT: 3,       // 调整违规次数阈值
  MAX_PAUSE_TIME: 5000,      // 调整暂停超时时间
}
```

### 修改极限速度

```javascript
MIN_DROP_INTERVAL: 200,  // 调整最小下落间隔
```

⚠️ **警告：** 低于 200ms 可能导致游戏体验下降！

## 数据统计

### 记录字段

```javascript
player.speedViolations = 0;     // 速度违规次数
player.pauseCount = 0;          // 暂停次数
player.currentPieceStartTime;   // 当前方块开始时间
```

### 日志示例

**正常游戏：**
```
玩家 张三 (player_xxx)
  等级: 5 (专家)
  下落时间: 550ms (期望: 480-720ms)
  状态: 正常
```

**检测到作弊：**
```
速度作弊检测: 玩家 张三 (player_xxx)
  原因: 方块下落过快 (100ms < 480ms)
  实际时间: 100ms
  期望范围: 480ms - 720ms
  违规次数: 3/3
  判定: 作弊
```

## 性能影响

**服务端开销：**
- 时间计算：< 1ms
- 验证逻辑：< 1ms
- 总计：可忽略

**网络开销：**
- 每次请求多传输难度信息：+100 bytes
- 总体影响：< 1%

**用户体验：**
- 难度过渡平滑
- 提示清晰明确
- 无卡顿无延迟

## 测试方法

### 手动测试

**1. 正常游戏测试**
```
1. 开始游戏
2. 正常操作，达到 500 分
3. 观察难度是否提升到等级 2
4. 继续游戏，观察速度变化
```

**2. 暂停检测测试**
```
1. 开始游戏
2. 玩一会后，停止操作 > 5 秒
3. 预期：游戏终止，提示暂停作弊
```

**3. 速度检测测试**
```
1. 修改客户端代码，强制加速
2. 预期：3 次违规后游戏终止
```

## 总结

难度递增系统为游戏提供了：

✅ **循序渐进的挑战** - 12 个难度等级  
✅ **人性化的体验** - 不超过人类极限  
✅ **公平的竞技** - 防止速度作弊  
✅ **智能的检测** - 容错网络延迟  
✅ **平滑的过渡** - 动态调整速度  

这为所有玩家提供了公平、有趣、富有挑战性的游戏体验！
