# 断连检测功能快速测试

## 前置准备

1. 启动服务器：
```bash
cd /Users/lvqier/hackson-260116/server
node server.js
```

2. 确认看到日志：
```
断连检测已启动（间隔: 10秒，超时阈值: 30秒）
```

## 测试场景

### 场景1：正常关闭标签页（最常见）

**步骤**：
1. 浏览器打开 http://localhost:3000
2. 登录并开始游戏
3. 打开管理后台 http://localhost:3000/admin.html
4. 确认管理后台显示玩家状态为 "playing"
5. **直接关闭游戏标签页**
6. 立即查看管理后台

**预期结果**：
- ✅ 管理后台立即显示玩家状态变为 "finished"
- ✅ 服务器日志显示：
  ```
  WebSocket连接关闭: type=player, playerId=player_xxx
  玩家 XX (player_xxx) 断开连接时正在游戏中，自动结束游戏
  ```

**实际响应时间**：< 1秒

---

### 场景2：网络中断（次常见）

**步骤**：
1. 浏览器打开 http://localhost:3000
2. 登录并开始游戏
3. 打开管理后台（可以用另一台设备）
4. **断开WiFi或拔掉网线**
5. 等待30秒
6. 查看管理后台

**预期结果**：
- ✅ 30秒后管理后台显示玩家状态变为 "finished"
- ✅ 服务器日志显示：
  ```
  检测到玩家 XX (player_xxx) 超时未响应，自动结束游戏
    最后活跃时间: 2026-01-15 14:30:00
    超时时长: 31秒
  ```

**实际响应时间**：30-40秒

---

### 场景3：浏览器刷新（验证不影响重连）

**步骤**：
1. 浏览器打开 http://localhost:3000
2. 登录并开始游戏
3. **按F5刷新页面**
4. 重新开始游戏

**预期结果**：
- ✅ 刷新时旧游戏自动结束
- ✅ 可以正常开始新游戏
- ✅ 之前的分数记录保留

---

### 场景4：切换标签页（验证不会误判）

**步骤**：
1. 浏览器打开 http://localhost:3000
2. 登录并开始游戏
3. **切换到其他标签页**（不关闭）
4. 等待1-2分钟
5. 切换回游戏标签页

**预期结果**：
- ✅ 游戏仍在运行（状态为 "playing"）
- ✅ 心跳机制保持连接
- ✅ 可以继续游戏

**验证方法**：查看浏览器控制台应该看到心跳日志

---

### 场景5：设备休眠（模拟离开）

**步骤**：
1. 笔记本打开游戏并开始
2. 确认管理后台显示 "playing"
3. **合上笔记本盖子**（进入休眠）
4. 等待1分钟
5. 打开盖子，查看管理后台

**预期结果**：
- ✅ 管理后台显示玩家状态为 "finished"
- ✅ 分数已记录

---

## 调试技巧

### 查看客户端心跳

打开浏览器控制台（F12），切换到 Console 标签，应该能看到：
```javascript
心跳已启动
```

### 查看服务器日志

终端中应该能看到：
```
断连检测已启动（间隔: 10秒，超时阈值: 30秒）
```

### 模拟网络延迟

Chrome DevTools → Network → Throttling → Slow 3G
- 验证心跳在慢速网络下也能正常工作

### 手动触发断连

在浏览器控制台执行：
```javascript
ws.close(); // 手动关闭WebSocket
```

---

## 常见问题

### Q1: 心跳日志在哪里看？
**A**: 客户端心跳日志在浏览器控制台（F12），服务器只在收到ping时更新活跃时间，不打印日志。

### Q2: 为什么是30秒超时？
**A**: 
- 10秒心跳间隔
- 允许2-3次心跳失败（网络波动）
- 30秒是合理的超时阈值

### Q3: 如何调整超时时间？
**A**: 修改 `gameManager.js` 中的 `TIMEOUT_THRESHOLD`：
```javascript
const TIMEOUT_THRESHOLD = 60000; // 改为60秒
```

### Q4: 断连后能恢复游戏吗？
**A**: 当前版本不支持，游戏会自动结束。未来可以添加"断线重连"功能。

### Q5: 手动暂停会被判定为断连吗？
**A**: 不会！暂停状态下仍有心跳，不会触发超时。

---

## 性能指标

| 指标 | 值 |
|-----|-----|
| 心跳频率 | 10秒/次 |
| 检测频率 | 10秒/次 |
| 超时阈值 | 30秒 |
| 正常断开响应 | < 1秒 |
| 超时断开响应 | 30-40秒 |
| 额外流量 | ~50 bytes/10秒 |
| CPU占用 | 可忽略 |

---

## 压力测试

测试100个并发玩家：

```bash
# 使用压力测试工具（如果需要）
# 这里只是示例，实际需要专门的测试脚本
for i in {1..100}; do
  # 打开100个浏览器标签
done
```

**预期**：
- ✅ 所有玩家的心跳正常
- ✅ 断开检测准确
- ✅ 服务器CPU < 10%
- ✅ 内存增长 < 100MB

---

## 通过标准

- ✅ 场景1（关闭标签页）：< 1秒响应
- ✅ 场景2（网络中断）：< 40秒响应
- ✅ 场景3（刷新）：不影响重连
- ✅ 场景4（切换标签页）：不误判
- ✅ 场景5（设备休眠）：正确检测

全部通过 = 功能正常 ✅
