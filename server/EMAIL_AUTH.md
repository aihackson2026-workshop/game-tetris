# 邮箱验证功能说明

## 概述

系统现在支持基于邮箱的账号绑定和验证功能。玩家首次登录时需要提供昵称和邮箱，系统会将两者绑定。后续登录时，需要使用相同的邮箱验证身份。

## 功能特性

### 1. 账号绑定
- ✅ 首次注册时绑定昵称和邮箱
- ✅ 昵称-邮箱映射永久保存
- ✅ 数据持久化到本地文件

### 2. 身份验证
- ✅ 老玩家登录需验证邮箱
- ✅ 邮箱不匹配时拒绝登录
- ✅ 保护玩家账号安全

### 3. 数据安全
- ✅ 邮箱格式验证
- ✅ 防止昵称被恶意占用
- ✅ 支持数据恢复和迁移

## 使用流程

### 新玩家注册

**步骤：**
1. 访问 http://localhost:3001/game.html
2. 输入昵称（2-20个字符）
3. 输入邮箱地址
4. 点击"登录/注册"

**系统行为：**
- 检查昵称是否已存在
- 如果是新昵称，创建新账号
- 绑定昵称和邮箱
- 保存到数据库

**示例：**
```
昵称：张三
邮箱：zhangsan@example.com
结果：✓ 注册成功，账号已创建
```

### 老玩家登录

**步骤：**
1. 访问 http://localhost:3001/game.html
2. 输入之前注册的昵称
3. 输入绑定的邮箱地址
4. 点击"登录/注册"

**系统行为：**
- 检查昵称是否存在
- 验证邮箱是否匹配
- 匹配成功则登录
- 恢复历史最高分和游戏记录

**示例：**
```
昵称：张三
邮箱：zhangsan@example.com
结果：✓ 欢迎回来！历史最高分：1200
```

### 错误的邮箱

**步骤：**
1. 输入已存在的昵称
2. 输入错误的邮箱
3. 点击"登录/注册"

**系统行为：**
- 检测到昵称已被注册
- 验证邮箱不匹配
- **拒绝登录**
- 提示"昵称已被占用，请使用正确的邮箱或更换昵称"

**示例：**
```
昵称：张三
邮箱：lisi@example.com（错误）
结果：✗ 昵称已被占用，请使用正确的邮箱或更换昵称
```

## 技术实现

### 前端验证

**邮箱格式验证：**
```javascript
const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
if (!emailRegex.test(email)) {
  // 拒绝无效邮箱
}
```

**必填字段验证：**
- 昵称：2-20个字符
- 邮箱：必须填写且格式正确

### 后端逻辑

**验证流程：**
```javascript
validateNicknameEmail(nickname, email) {
  // 1. 昵称不存在 → 新玩家
  if (!this.nicknames.has(nickname)) {
    return { isValid: true, isNewPlayer: true };
  }

  // 2. 昵称存在，检查邮箱
  const registeredEmail = this.nicknameEmailMap.get(nickname);
  
  // 3. 邮箱匹配 → 老玩家登录
  if (registeredEmail === email) {
    return { isValid: true, isNewPlayer: false };
  }
  
  // 4. 邮箱不匹配 → 拒绝
  return { 
    isValid: false, 
    error: '昵称已被占用，请使用正确的邮箱或更换昵称' 
  };
}
```

### 数据存储

**数据结构：**
```json
{
  "players": [
    {
      "id": "player_xxx",
      "nickname": "张三",
      "email": "zhangsan@example.com",
      "highestScore": 1200,
      "history": [...]
    }
  ],
  "nicknames": ["张三", "李四"],
  "lastUpdated": "2026-01-14T15:00:00.000Z"
}
```

**存储位置：**
- 文件：`data/players.json`
- 内存：`Map<nickname, email>`

## API 接口

### POST /api/player/register

**请求：**
```json
{
  "nickname": "张三",
  "email": "zhangsan@example.com"
}
```

**响应（新玩家）：**
```json
{
  "success": true,
  "isNewPlayer": true,
  "player": {
    "id": "player_xxx",
    "nickname": "张三",
    "email": "zhangsan@example.com",
    "highestScore": 0
  }
}
```

**响应（老玩家）：**
```json
{
  "success": true,
  "isNewPlayer": false,
  "player": {
    "id": "player_xxx",
    "nickname": "张三",
    "email": "zhangsan@example.com",
    "highestScore": 1200
  }
}
```

**响应（错误）：**
```json
{
  "success": false,
  "error": "昵称已被占用，请使用正确的邮箱或更换昵称"
}
```

## 测试用例

### 测试脚本

运行自动化测试：
```bash
source ~/.nvm/nvm.sh && node test-email-validation.js
```

### 手动测试

**场景1：新玩家注册**
1. 昵称：`新玩家_${Date.now()}`
2. 邮箱：`newuser@example.com`
3. 预期：✓ 注册成功

**场景2：老玩家正确登录**
1. 昵称：使用已注册的昵称
2. 邮箱：使用绑定的邮箱
3. 预期：✓ 登录成功，显示历史最高分

**场景3：老玩家错误邮箱**
1. 昵称：使用已注册的昵称
2. 邮箱：使用错误的邮箱
3. 预期：✗ 拒绝登录，提示昵称已被占用

**场景4：无效邮箱格式**
1. 昵称：任意
2. 邮箱：`invalid-email`
3. 预期：✗ 提示邮箱格式无效

**场景5：空邮箱**
1. 昵称：任意
2. 邮箱：留空
3. 预期：✗ 提示邮箱不能为空

## 安全考虑

### 当前实现

✅ **邮箱格式验证** - 防止无效邮箱
✅ **昵称-邮箱绑定** - 防止昵称被恶意占用
✅ **数据持久化** - 重启后数据不丢失
✅ **错误提示** - 明确的错误信息

### 可选增强

如果需要更高的安全性，可以考虑：

- [ ] 邮箱验证码验证
- [ ] 密码保护
- [ ] 邮箱找回功能
- [ ] 登录日志记录
- [ ] IP 限流防止暴力破解
- [ ] 邮箱加密存储

## 数据迁移

### 老玩家数据兼容

系统会自动处理没有邮箱的老玩家数据：

```javascript
if (validation.needsEmailUpdate) {
  // 首次登录时绑定邮箱
  player.email = email;
  this.nicknameEmailMap.set(nickname, email);
}
```

**流程：**
1. 老玩家首次使用新系统
2. 输入昵称 + 邮箱
3. 系统检测到没有绑定邮箱
4. 自动绑定并保存
5. 下次登录需要使用这个邮箱

## 常见问题

### Q: 忘记绑定的邮箱怎么办？

**A:** 目前需要联系管理员手动修改数据文件 `data/players.json`，或者使用新昵称重新注册。

### Q: 可以更换邮箱吗？

**A:** 目前不支持自助更换。需要管理员手动修改数据文件。

### Q: 邮箱会被公开吗？

**A:** 不会。邮箱只用于验证身份，不会在游戏中显示或分享给其他玩家。

### Q: 数据会丢失吗？

**A:** 不会。所有数据都保存在 `data/players.json` 文件中，定期自动保存，服务器重启后自动恢复。

### Q: 可以用临时邮箱吗？

**A:** 可以，系统只验证格式，不验证邮箱是否真实存在。但建议使用真实邮箱，避免遗忘。

## 总结

邮箱验证功能为游戏系统提供了基本的账号保护机制：

✅ **防止昵称被占用** - 只有知道邮箱的人才能登录
✅ **数据安全** - 玩家数据绑定到邮箱
✅ **持久化存储** - 重启后数据自动恢复
✅ **简单易用** - 不需要复杂的密码或验证码

这为未来添加更多账号功能（如密码保护、找回账号等）打下了基础。
