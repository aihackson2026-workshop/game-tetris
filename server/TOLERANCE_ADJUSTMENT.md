# 容错机制调整说明

## 问题反馈

**用户反馈：** 玩着玩着提示"检测到多次暂停游戏，疑似作弊"，但实际没有操作暂停。

**原因分析：**
1. 玩家思考时间过长（特别是在高难度下）
2. 网络波动导致延迟
3. 浏览器标签页切换导致短暂卡顿
4. 原有容错参数过于严格

## 调整方案

### 1. 增加速度容差

**调整前：**
```javascript
TOLERANCE_RATIO: 0.2,  // 20% 容错
```

**调整后：**
```javascript
TOLERANCE_RATIO: 0.5,  // 50% 容错
```

**影响：**
- 等级 1 (1000ms): 800-1200ms → 500-1500ms
- 等级 5 (600ms): 480-720ms → 300-900ms
- 等级 12 (200ms): 160-240ms → 100-300ms

### 2. 添加固定超时容差

**新增参数：**
```javascript
EXTRA_TOLERANCE_MS: 1000,  // 额外允许 1 秒超时
```

**计算方式：**
```javascript
max = 理想时间 × (1 + 50%) + 1000ms
```

**示例：**
- 等级 1 (1000ms): 最大允许 2500ms (1000×1.5+1000)
- 等级 5 (600ms): 最大允许 1900ms (600×1.5+1000)
- 等级 12 (200ms): 最大允许 1300ms (200×1.5+1000)

### 3. 放宽暂停检测

**调整前：**
```javascript
MAX_PAUSE_TIME: 5000,   // 超过5秒视为暂停
PAUSE_TOLERANCE: 2      // 允许暂停2次
```

**调整后：**
```javascript
MAX_PAUSE_TIME: 10000,  // 超过10秒视为暂停
PAUSE_TOLERANCE: 5      // 允许暂停5次
```

### 4. 提高违规阈值

**调整前：**
```javascript
SUSPICIOUS_COUNT: 3,  // 连续3次异常判定作弊
```

**调整后：**
```javascript
SUSPICIOUS_COUNT: 5,  // 连续5次异常判定作弊
```

### 5. 放宽最小时间限制

**调整前：**
```javascript
MIN_FALL_TIME: 100,  // 100ms 极限
```

**调整后：**
```javascript
MIN_FALL_TIME: 50,   // 50ms 极限（更宽松）
```

### 6. 优化恢复机制

**调整前：**
```javascript
// 正常一次，违规计数 -1
player.speedViolations = Math.max(0, player.speedViolations - 1);
```

**调整后：**
```javascript
// 正常一次，违规计数 -0.5（更温和的恢复）
player.speedViolations = Math.max(0, player.speedViolations - 0.5);
```

## 调整效果对比

### 场景1：玩家思考

**情况：**
玩家在高难度下思考最佳位置，方块下落时间 2 秒

**调整前：**
```
等级 5 (600ms)
期望范围: 480-720ms
实际时间: 2000ms
判定: 正常（未超过 5 秒）
```

**调整后：**
```
等级 5 (600ms)
期望范围: 300-1900ms
实际时间: 2000ms
判定: 稍慢但在 10 秒内，正常
```

### 场景2：网络波动

**情况：**
网络延迟导致连续几次下落时间略长

**调整前：**
```
方块1: 800ms (期望 480-720ms) - 超出范围但未判违规
方块2: 850ms (期望 480-720ms) - 超出范围但未判违规
方块3: 900ms (期望 480-720ms) - 超出范围但未判违规
判定: 正常（慢了但未超时）
```

**调整后：**
```
方块1: 800ms (期望 300-1900ms) - 正常范围内
方块2: 850ms (期望 300-1900ms) - 正常范围内
方块3: 900ms (期望 300-1900ms) - 正常范围内
判定: 完全正常
```

### 场景3：浏览器标签切换

**情况：**
玩家短暂切换标签页，导致卡顿 6 秒

**调整前：**
```
实际时间: 6000ms
超时阈值: 5000ms
暂停计数: +1 (共 1/2)
判定: 警告，暂停 1 次
```

**调整后：**
```
实际时间: 6000ms
超时阈值: 10000ms
判定: 正常（未超过 10 秒）
```

### 场景4：真实作弊（暂停游戏）

**情况：**
玩家使用外挂暂停游戏 15 秒

**调整前：**
```
实际时间: 15000ms
超时阈值: 5000ms
暂停计数: +1
连续 2 次后: 判定作弊
```

**调整后：**
```
实际时间: 15000ms
超时阈值: 10000ms
暂停计数: +1
连续 5 次后: 判定作弊
```

**说明：** 虽然更宽松，但真实作弊仍会被检测到

## 详细参数对照表

| 参数 | 调整前 | 调整后 | 变化 |
|------|--------|--------|------|
| 速度容差 | 20% | 50% | +150% |
| 固定超时容差 | 0ms | 1000ms | +1000ms |
| 最小下落时间 | 100ms | 50ms | -50% |
| 暂停超时阈值 | 5000ms | 10000ms | +100% |
| 允许暂停次数 | 2 次 | 5 次 | +150% |
| 违规判定阈值 | 3 次 | 5 次 | +67% |
| 恢复速率 | -1/次 | -0.5/次 | -50% |

## 各难度级别允许范围

| 等级 | 理想速度 | 调整前范围 | 调整后范围 | 额外容差 |
|------|---------|-----------|-----------|---------|
| 1 (新手) | 1000ms | 800-1200ms | 500-2500ms | +150% |
| 2 (初级) | 900ms | 720-1080ms | 450-2350ms | +159% |
| 3 (中级) | 800ms | 640-960ms | 400-2200ms | +175% |
| 4 (高级) | 700ms | 560-840ms | 350-2050ms | +193% |
| 5 (专家) | 600ms | 480-720ms | 300-1900ms | +217% |
| 6 (大师) | 500ms | 400-600ms | 250-1750ms | +250% |
| 7 (宗师) | 450ms | 360-540ms | 225-1675ms | +272% |
| 8 (传奇) | 400ms | 320-480ms | 200-1600ms | +300% |
| 9 (神话) | 350ms | 280-420ms | 175-1525ms | +336% |
| 10 (至尊) | 300ms | 240-360ms | 150-1450ms | +383% |
| 11 (超凡) | 250ms | 200-300ms | 125-1375ms | +450% |
| 12 (神级) | 200ms | 160-240ms | 100-1300ms | +550% |

## 改进效果

### 优点

1. **更人性化**
   - 允许玩家有足够的思考时间
   - 考虑网络波动和浏览器行为
   - 不会因为偶尔操作慢而被误判

2. **更公平**
   - 不同网络环境的玩家都能正常游戏
   - 减少误判率

3. **体验更好**
   - 玩家不会频繁被打断
   - 可以更专注于游戏本身

### 仍然有效的防护

1. **真实暂停仍会被检测**
   - 超过 10 秒的暂停会被记录
   - 累计 5 次暂停仍会被判定作弊

2. **极端加速仍会被拦截**
   - 连续 5 次明显过快会被判定
   - 防止使用加速外挂

3. **明显异常仍会被记录**
   - 所有异常都会在服务端日志中记录
   - 方便后续分析和调整

## 建议

### 进一步优化方向

1. **自适应容差**
   ```javascript
   // 根据玩家历史表现动态调整容差
   if (player.avgFallTime > expected.ideal * 1.2) {
     // 这个玩家操作较慢，给予更多容差
     tolerance += 500;
   }
   ```

2. **网络延迟补偿**
   ```javascript
   // 检测 WebSocket 延迟并补偿
   const networkDelay = measureNetworkLatency();
   expectedMax += networkDelay * 2;
   ```

3. **暂停原因分析**
   ```javascript
   // 区分主动暂停和标签页切换
   document.addEventListener('visibilitychange', () => {
     if (document.hidden) {
       // 标签页切换，不算作弊
     }
   });
   ```

## 总结

通过以上调整，系统的容错性大幅提升：

✅ **速度容差：20% → 50%**  
✅ **固定容差：0ms → 1000ms**  
✅ **暂停阈值：5秒 → 10秒**  
✅ **允许暂停：2次 → 5次**  
✅ **违规阈值：3次 → 5次**  

这些调整在保持防作弊能力的同时，大幅改善了正常玩家的游戏体验。

现在可以重新试玩，应该不会再出现误判了！🎮
