<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏厅后台管理</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .panel h2 {
            color: #667eea;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-item {
            padding: 12px;
            margin-bottom: 10px;
            background: #f5f5f5;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-item:hover {
            background: #e3f2fd;
            transform: translateX(5px);
        }

        .player-item.playing {
            border-left: 4px solid #4caf50;
        }

        .player-info {
            flex: 1;
        }

        .player-name {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .player-score {
            color: #666;
            font-size: 0.9em;
        }

        .player-duration {
            color: #667eea;
            font-size: 0.9em;
            margin-left: 10px;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: bold;
        }

        .status-playing {
            background: #4caf50;
            color: white;
        }

        .status-finished {
            background: #9e9e9e;
            color: white;
        }

        .leaderboard-table {
            width: 100%;
            border-collapse: collapse;
        }

        .leaderboard-table th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .leaderboard-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
        }

        .leaderboard-table tr:hover {
            background: #f5f5f5;
        }

        .rank {
            font-weight: bold;
            color: #667eea;
        }

        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }

        #gameView {
            grid-column: 1 / -1;
            display: none;
        }

        #gameView.active {
            display: block;
        }

        .game-canvas-container {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }

        .canvas-wrapper {
            flex: 0 0 auto;
        }

        #gameCanvas {
            border: 3px solid #667eea;
            border-radius: 8px;
            background: #000;
        }

        .game-info {
            flex: 1;
        }

        .info-item {
            padding: 15px;
            background: #f5f5f5;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .info-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #333;
            font-size: 1.5em;
            font-weight: bold;
        }

        .close-btn {
            padding: 10px 20px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: #d32f2f;
        }

        .empty-state {
            text-align: center;
            color: #999;
            padding: 40px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .connection-status.connected {
            background: #4caf50;
        }

        .connection-status.disconnected {
            background: #f44336;
        }

        .btn-delete {
            padding: 4px 10px;
            background: #f44336;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            transition: background 0.3s;
        }

        .btn-delete:hover {
            background: #d32f2f;
        }

        .action-cell {
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="connection-status" id="connectionStatus">连接中...</div>

    <div class="container">
        <h1>俄罗斯方块游戏厅 - 后台管理</h1>

        <div class="dashboard">
            <div class="panel">
                <h2>正在游戏的玩家</h2>
                <div class="player-list" id="playingPlayers">
                    <div class="empty-state">暂无玩家在线</div>
                </div>
            </div>

            <div class="panel">
                <h2>排行榜</h2>
                <table class="leaderboard-table">
                    <thead>
                        <tr>
                            <th>排名</th>
                            <th>昵称</th>
                            <th>分数</th>
                            <th>状态</th>
                            <th>耗时</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="leaderboardBody">
                        <tr>
                            <td colspan="6" class="empty-state">暂无数据</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="panel" id="gameView">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="viewingPlayerName">玩家游戏界面</h2>
                    <button class="close-btn" onclick="closeGameView()">关闭</button>
                </div>
                <div class="game-canvas-container">
                    <div class="canvas-wrapper">
                        <canvas id="gameCanvas" width="300" height="600"></canvas>
                    </div>
                    <div class="game-info">
                        <div class="info-item">
                            <div class="info-label">当前分数</div>
                            <div class="info-value" id="currentScore">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">已消除行数</div>
                            <div class="info-value" id="linesCleared">0</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">等级</div>
                            <div class="info-value" id="currentLevel">1</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">游戏时长</div>
                            <div class="info-value" id="gameDuration">00:00</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let ws = null;
        let currentViewingPlayerId = null;
        let viewUpdateInterval = null;

        // WebSocket连接
        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}?type=admin`;
            
            ws = new WebSocket(wsUrl);

            ws.onopen = () => {
                console.log('WebSocket已连接');
                updateConnectionStatus(true);
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                handleWebSocketMessage(message);
            };

            ws.onclose = () => {
                console.log('WebSocket连接断开');
                updateConnectionStatus(false);
                setTimeout(connectWebSocket, 3000);
            };

            ws.onerror = (error) => {
                console.error('WebSocket错误:', error);
            };
        }

        // 处理WebSocket消息
        function handleWebSocketMessage(message) {
            switch (message.type) {
                case 'init':
                    updatePlayingPlayers(message.players);
                    updateLeaderboard(message.leaderboard);
                    break;
                case 'playerStatusUpdate':
                    fetchPlayingPlayers();
                    break;
                case 'leaderboardUpdate':
                    updateLeaderboard(message.leaderboard);
                    // 刷新正在玩玩家列表（可能有玩家开始/结束游戏）
                    fetchPlayingPlayers();
                    break;
                case 'gameStateUpdate':
                    if (currentViewingPlayerId === message.playerId) {
                        updateGameView(message.gameState);
                    }
                    break;
                case 'gameStateResponse':
                    if (message.data && message.data.gameState) {
                        updateGameView(message.data.gameState);
                    }
                    break;
                case 'durationUpdate':
                    if (message.players) {
                        // 刷新正在玩玩家列表（可能有新玩家开始游戏）
                        fetchPlayingPlayers();
                        // 刷新排行榜（分数可能已变化）
                        refreshLeaderboard();
                    }
                    break;
            }
        }

        // 格式化时长
        function formatDuration(durationMs) {
            if (!durationMs) return '00:00';
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.floor((durationMs % 60000) / 1000);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 更新正在玩的玩家列表
        function updatePlayingPlayers(players) {
            const container = document.getElementById('playingPlayers');
            
            if (!players || players.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无玩家在线</div>';
                return;
            }

            container.innerHTML = players.map(entry => `
                <div class="player-item playing" onclick="viewPlayerGame('${entry.playerId}', '${entry.nickname}')">
                    <div class="player-info">
                        <div class="player-name">${entry.nickname}</div>
                        <div class="player-score">当前: ${entry.score || 0}</div>
                    </div>
                    <span class="player-duration" id="playing-duration-${entry.id}">${formatDuration(entry.duration)}</span>
                    <span class="status-badge status-playing">当前</span>
                </div>
            `).join('');
        }

        // 更新正在玩玩家时长（实时更新）
        function updatePlayingPlayersDuration(players) {
            players.forEach(player => {
                // 更新正在玩玩家列表中的时长
                const playingDurationEl = document.getElementById(`playing-duration-${player.playerId}_current`);
                if (playingDurationEl) {
                    playingDurationEl.textContent = formatDuration(player.duration);
                }
                
                // 更新排行榜中的时长（当前分条目）
                const leaderboardDurationEl = document.getElementById(`leaderboard-duration-${player.playerId}_current`);
                if (leaderboardDurationEl) {
                    leaderboardDurationEl.textContent = formatDuration(player.duration);
                }
                
                // 如果正在查看这个玩家，更新游戏视图中的时长
                if (currentViewingPlayerId === player.playerId) {
                    document.getElementById('gameDuration').textContent = formatDuration(player.duration);
                }
            });
        }

        // 更新连接状态
        function updateConnectionStatus(connected) {
            const statusEl = document.getElementById('connectionStatus');
            if (connected) {
                statusEl.textContent = '已连接';
                statusEl.className = 'connection-status connected';
            } else {
                statusEl.textContent = '未连接';
                statusEl.className = 'connection-status disconnected';
            }
        }

        // 获取正在玩的玩家
        async function fetchPlayingPlayers() {
            try {
                const response = await fetch('/api/players/playing');
                const players = await response.json();
                // 更新正在玩玩家列表
                updatePlayingPlayers(players);
                // 转换为与durationUpdate消息相同的格式
                const playersWithFormat = players.map(p => ({
                    playerId: p.id,
                    nickname: p.nickname,
                    duration: p.duration,
                    score: p.currentScore
                }));
                updatePlayingPlayersDuration(playersWithFormat);
            } catch (error) {
                console.error('获取玩家列表失败:', error);
            }
        }

        // 更新正在玩的玩家列表
        function updatePlayingPlayers(players) {
            const container = document.getElementById('playingPlayers');
            
            if (!players || players.length === 0) {
                container.innerHTML = '<div class="empty-state">暂无玩家在线</div>';
                return;
            }

            container.innerHTML = players.map(player => `
                <div class="player-item playing" onclick="viewPlayerGame('${player.id}', '${player.nickname}')">
                    <div class="player-info">
                        <div class="player-name">${player.nickname}</div>
                        <div class="player-score">当前分数: ${player.currentScore || 0}</div>
                    </div>
                    <span class="player-duration" id="playing-duration-${player.id}">${formatDuration(player.duration)}</span>
                    <span class="status-badge status-playing">游戏中</span>
                </div>
            `).join('');
        }

        // 更新排行榜
        function updateLeaderboard(leaderboard) {
            const tbody = document.getElementById('leaderboardBody');
            
            if (!leaderboard || !leaderboard.all || leaderboard.all.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">暂无数据</td></tr>';
                return;
            }

            tbody.innerHTML = leaderboard.all.map((entry, index) => {
                const rank = index + 1;
                const rankClass = rank <= 3 ? `rank-${rank}` : 'rank';
                const statusClass = entry.isCurrent ? 'status-playing' : 'status-finished';
                const statusText = entry.isCurrent ? '当前' : '最高';
                const playerId = entry.playerId || '';
                const label = entry.isCurrent ? '当前分' : '最高分';
                
                return `
                    <tr>
                        <td class="${rankClass}">#${rank}</td>
                        <td>${entry.nickname}</td>
                        <td>
                            <div style="font-weight: bold;">${entry.score}</div>
                            <div style="font-size: 0.8em; color: #667eea;">${label}</div>
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td id="leaderboard-duration-${entry.id}">${formatDuration(entry.duration)}</td>
                        <td class="action-cell">
                            ${!entry.isCurrent ? `<button class="btn-delete" onclick="deletePlayer('${playerId}', '${entry.nickname}')">删除</button>` : '-'}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // 格式化时长
        function formatDuration(durationMs) {
            if (!durationMs && durationMs !== 0) return '-';
            const minutes = Math.floor(durationMs / 60000);
            const seconds = Math.floor((durationMs % 60000) / 1000);
            return `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // 删除单个玩家记录
        async function deletePlayer(playerId, nickname) {
            if (!confirm(`确定要删除玩家 "${nickname}" 的记录吗？此操作不可恢复。`)) {
                return;
            }

            try {
                const response = await fetch(`/api/player/${playerId}`, {
                    method: 'DELETE'
                });
                const result = await response.json();

                if (result.success) {
                    alert(result.message);
                    refreshData();
                } else {
                    alert('删除失败: ' + result.message);
                }
            } catch (error) {
                console.error('删除玩家失败:', error);
                alert('删除失败: ' + error.message);
            }
        }

        // 刷新所有数据
        function refreshData() {
            fetchPlayingPlayers();
            refreshLeaderboard();
        }

        // 刷新排行榜
        function refreshLeaderboard() {
            fetch('/api/leaderboard')
                .then(res => res.json())
                .then(data => updateLeaderboard(data))
                .catch(err => console.error('获取排行榜失败:', err));
        }

        // 查看玩家游戏
        function viewPlayerGame(playerId, nickname) {
            currentViewingPlayerId = playerId;
            document.getElementById('viewingPlayerName').textContent = `${nickname} 的游戏界面`;
            document.getElementById('gameView').classList.add('active');

            // 不需要定期请求了，因为玩家端会实时推送
            // 只需要订阅这个玩家的实时更新
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'subscribePlayer',
                    playerId: playerId
                }));
            }
            
            // 清理旧的定时器（如果有）
            if (viewUpdateInterval) {
                clearInterval(viewUpdateInterval);
                viewUpdateInterval = null;
            }
        }

        // 关闭游戏视图
        function closeGameView() {
            // 取消订阅
            if (ws && ws.readyState === WebSocket.OPEN && currentViewingPlayerId) {
                ws.send(JSON.stringify({
                    type: 'unsubscribePlayer',
                    playerId: currentViewingPlayerId
                }));
            }
            
            currentViewingPlayerId = null;
            document.getElementById('gameView').classList.remove('active');
            
            if (viewUpdateInterval) {
                clearInterval(viewUpdateInterval);
                viewUpdateInterval = null;
            }
        }

        // 更新游戏画面（优化版本，使用requestAnimationFrame提升性能）
        let pendingGameState = null;
        let isRendering = false;

        function updateGameView(gameState) {
            if (!gameState) return;
            
            // 存储最新的游戏状态
            pendingGameState = gameState;
            
            // 如果正在渲染，不重复触发
            if (isRendering) return;
            
            isRendering = true;
            requestAnimationFrame(renderGameView);
        }

        function renderGameView() {
            if (!pendingGameState) {
                isRendering = false;
                return;
            }

            const gameState = pendingGameState;
            pendingGameState = null;

            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            const cellSize = 30;

            // 清空画布
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // 绘制游戏板
            if (gameState.board) {
                for (let y = 0; y < gameState.board.length; y++) {
                    for (let x = 0; x < gameState.board[y].length; x++) {
                        if (gameState.board[y][x]) {
                            ctx.fillStyle = getColorForCell(gameState.board[y][x]);
                            ctx.fillRect(x * cellSize + 1, y * cellSize + 1, cellSize - 2, cellSize - 2);
                        }
                    }
                }
            }

            // 绘制当前方块（高亮显示）
            if (gameState.currentPiece) {
                ctx.fillStyle = gameState.currentPiece.color || '#fff';
                const piece = gameState.currentPiece;
                if (piece.shape) {
                    for (let y = 0; y < piece.shape.length; y++) {
                        for (let x = 0; x < piece.shape[y].length; x++) {
                            if (piece.shape[y][x]) {
                                // 绘制方块主体
                                ctx.fillRect(
                                    (piece.x + x) * cellSize + 1,
                                    (piece.y + y) * cellSize + 1,
                                    cellSize - 2,
                                    cellSize - 2
                                );
                                
                                // 添加高光效果
                                ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                                ctx.fillRect(
                                    (piece.x + x) * cellSize + 2,
                                    (piece.y + y) * cellSize + 2,
                                    (cellSize - 4) / 2,
                                    (cellSize - 4) / 2
                                );
                                ctx.fillStyle = gameState.currentPiece.color || '#fff';
                            }
                        }
                    }
                }
            }

            // 绘制网格线（半透明）
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
            ctx.lineWidth = 0.5;
            for (let i = 0; i <= 10; i++) {
                ctx.beginPath();
                ctx.moveTo(i * cellSize, 0);
                ctx.lineTo(i * cellSize, canvas.height);
                ctx.stroke();
            }
            for (let i = 0; i <= 20; i++) {
                ctx.beginPath();
                ctx.moveTo(0, i * cellSize);
                ctx.lineTo(canvas.width, i * cellSize);
                ctx.stroke();
            }

            // 更新信息
            document.getElementById('currentScore').textContent = gameState.score || 0;
            document.getElementById('linesCleared').textContent = gameState.lines || 0;
            document.getElementById('currentLevel').textContent = gameState.level || 1;

            isRendering = false;
        }

        // 获取方块颜色
        function getColorForCell(cellValue) {
            const colors = {
                1: '#00f0f0', // I
                2: '#f0f000', // O
                3: '#a000f0', // T
                4: '#00f000', // S
                5: '#f00000', // Z
                6: '#0000f0', // J
                7: '#f0a000'  // L
            };
            return colors[cellValue] || '#fff';
        }

        // 初始化
        connectWebSocket();
        
        // 定期刷新数据（更频繁以实现实时效果）
        setInterval(() => {
            fetchPlayingPlayers();
            refreshLeaderboard();
        }, 2000);
    </script>
</body>
</html>
